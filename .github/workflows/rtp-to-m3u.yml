name: Convert RTP to M3U

on:
  # åªä¿ç•™æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Create output directory
        run: mkdir -p output/rtp
        
      - name: Create conversion script
        run: |
          cat > convert_rtp_to_m3u.py << 'EOF'
          import os
          import glob
          import datetime
          import re

          # è®°å½•è½¬æ¢æ—¶é—´
          now = datetime.datetime.utcnow()
          print(f"Conversion started at: {now.strftime('%Y-%m-%d %H:%M:%S')} UTC")

          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          os.makedirs("output/rtp", exist_ok=True)
          
          # é¢‘é“LOGOåŸºç¡€URL
          LOGO_BASE_URL = "https://raw.githubusercontent.com/fanmingming/live/main/tv/"

          # é¢‘é“åˆ†ç»„å’Œæ ‡è¯†æ˜ å°„
          def get_channel_info(channel_name):
              # é¢‘é“åç§°æ ‡å‡†åŒ–å’Œæ¸…ç†
              clean_name = channel_name.strip()
              
              # åˆå§‹åŒ–è¿”å›æ•°æ®
              info = {
                  "tvg_id": clean_name,
                  "tvg_name": clean_name,
                  "tvg_logo": "",
                  "group_title": "ğŸ“ºå…¶ä»–é¢‘é“"
              }
              
              # CCTVé¢‘é“å¤„ç†
              if re.search(r'^CCTV', clean_name, re.IGNORECASE):
                  # æå–CCTVåé¢çš„æ•°å­—æˆ–åç§°
                  cctv_match = re.search(r'^CCTV[-\s]*(\d+)[\s]*(.*?)$', clean_name, re.IGNORECASE)
                  if cctv_match:
                      cctv_num = cctv_match.group(1)
                      # ç”Ÿæˆæ ‡å‡†åŒ–çš„é¢‘é“åç§°
                      std_name = f"CCTV-{cctv_num}"
                      info["tvg_id"] = std_name
                      info["tvg_name"] = std_name
                      info["tvg_logo"] = f"{LOGO_BASE_URL}CCTV{cctv_num}.png"
                      info["group_title"] = "ğŸ“ºå¤®è§†é¢‘é“"
                  else:
                      info["tvg_logo"] = f"{LOGO_BASE_URL}CCTV.png"
                      info["group_title"] = "ğŸ“ºå¤®è§†é¢‘é“"
              
              # å«è§†é¢‘é“å¤„ç†
              elif re.search(r'å«è§†$', clean_name):
                  # æå–å«è§†åç§°
                  ws_match = re.search(r'^(.+)å«è§†$', clean_name)
                  if ws_match:
                      ws_name = ws_match.group(1)
                      info["tvg_logo"] = f"{LOGO_BASE_URL}{ws_name}å«è§†.png"
                      info["group_title"] = "ğŸ“ºå«è§†é¢‘é“"
              
              # å…¶ä»–ç±»å‹é¢‘é“åˆ†ç»„
              elif re.search(r'(ä¸Šæµ·|ä¸œæ–¹)', clean_name):
                  info["group_title"] = "ğŸ“ºä¸Šæµ·é¢‘é“"
                  if "ä¸Šæµ·" in clean_name:
                      info["tvg_logo"] = f"{LOGO_BASE_URL}ä¸Šæµ·{clean_name.replace('ä¸Šæµ·','')}.png"
                  elif "ä¸œæ–¹" in clean_name:
                      info["tvg_logo"] = f"{LOGO_BASE_URL}{clean_name}.png"
              elif re.search(r'(åŒ—äº¬|BTV)', clean_name):
                  info["group_title"] = "ğŸ“ºåŒ—äº¬é¢‘é“"
                  if "BTV" in clean_name:
                      btv_match = re.search(r'BTV[-\s]*(\d+)', clean_name)
                      if btv_match:
                          info["tvg_logo"] = f"{LOGO_BASE_URL}BTV{btv_match.group(1)}.png"
              elif re.search(r'(å¹¿ä¸œ|æ·±åœ³|å¹¿å·)', clean_name):
                  info["group_title"] = "ğŸ“ºå¹¿ä¸œé¢‘é“"
              elif re.search(r'(æµ™æ±Ÿ|æ­å·)', clean_name):
                  info["group_title"] = "ğŸ“ºæµ™æ±Ÿé¢‘é“"
              elif re.search(r'(æ±Ÿè‹|å—äº¬)', clean_name):
                  info["group_title"] = "ğŸ“ºæ±Ÿè‹é¢‘é“"
              elif re.search(r'(æ¹–å—|æ¹–åŒ—)', clean_name):
                  info["group_title"] = "ğŸ“ºæ¹–å—æ¹–åŒ—é¢‘é“"
              elif re.search(r'(å±±ä¸œ|å±±è¥¿)', clean_name):
                  info["group_title"] = "ğŸ“ºå±±ä¸œå±±è¥¿é¢‘é“"
              elif re.search(r'(è¾½å®|å‰æ—|é»‘é¾™æ±Ÿ)', clean_name):
                  info["group_title"] = "ğŸ“ºä¸œåŒ—é¢‘é“"
              elif re.search(r'(å››å·|é‡åº†|è´µå·|äº‘å—)', clean_name):
                  info["group_title"] = "ğŸ“ºè¥¿å—é¢‘é“"
              elif re.search(r'(æ²³å—|æ²³åŒ—)', clean_name):
                  info["group_title"] = "ğŸ“ºæ²³å—æ²³åŒ—é¢‘é“"
              elif re.search(r'(å®‰å¾½|ç¦å»º|æ±Ÿè¥¿)', clean_name):
                  info["group_title"] = "ğŸ“ºå®‰å¾½ç¦å»ºæ±Ÿè¥¿é¢‘é“"
              elif re.search(r'(é™•è¥¿|ç”˜è‚ƒ|å®å¤|æ–°ç–†|é’æµ·)', clean_name):
                  info["group_title"] = "ğŸ“ºè¥¿åŒ—é¢‘é“"
              elif re.search(r'(å†…è’™å¤|è¥¿è—)', clean_name):
                  info["group_title"] = "ğŸ“ºå†…è’™å¤è¥¿è—é¢‘é“"
              elif re.search(r'(CHC|ç”µå½±|å½±è§†|å‰§åœº)', clean_name):
                  info["group_title"] = "ğŸ¬å½±è§†é¢‘é“"
                  if "CHC" in clean_name:
                      info["tvg_logo"] = f"{LOGO_BASE_URL}CHC.png"
              elif re.search(r'(ä½“è‚²|è¶³çƒ|NBA)', clean_name):
                  info["group_title"] = "âš½ä½“è‚²é¢‘é“"
                  if "ä½“è‚²" in clean_name:
                      info["tvg_logo"] = f"{LOGO_BASE_URL}ä½“è‚².png"
              elif re.search(r'(éŸ³ä¹|MTV)', clean_name):
                  info["group_title"] = "ğŸµéŸ³ä¹é¢‘é“"
              elif re.search(r'(æ–°é—»|èµ„è®¯)', clean_name):
                  info["group_title"] = "ğŸ“°æ–°é—»é¢‘é“"
              elif re.search(r'(å°‘å„¿|åŠ¨ç”»|å¡é€š)', clean_name):
                  info["group_title"] = "ğŸ§¸å°‘å„¿é¢‘é“"
              elif re.search(r'(çºªå½•ç‰‡|æ¢ç´¢|Discovery|å›½å®¶åœ°ç†)', clean_name):
                  info["group_title"] = "ğŸŒçºªå½•ç‰‡é¢‘é“"
                  
              # å°è¯•ä¸ºæ²¡æœ‰åŒ¹é…åˆ°ç‰¹å®šè§„åˆ™çš„é¢‘é“ç”Ÿæˆlogo URL
              if not info["tvg_logo"] and not re.search(r'(æµ‹è¯•|å¤‡ç”¨|è´­ç‰©)', clean_name):
                  # ç§»é™¤å¸¸è§åç¼€å’Œç‰¹æ®Šå­—ç¬¦ï¼Œå°è¯•ç”Ÿæˆé€šç”¨logo URL
                  base_name = re.sub(r'[è¶…é«˜æ¸…]+$|[0-9]+$|[-\s]+$', '', clean_name)
                  base_name = re.sub(r'[^\w\u4e00-\u9fff]+', '', base_name)
                  if base_name:
                      info["tvg_logo"] = f"{LOGO_BASE_URL}{base_name}.png"
              
              return info

          # ç›´æ¥è·å–config/rtpç›®å½•ä¸‹çš„æ‰€æœ‰txtæ–‡ä»¶
          rtp_files = glob.glob("config/rtp/*.txt")
          
          if not rtp_files:
              print("WARNING: No RTP files found in config/rtp directory!")
              # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
              if not os.path.exists("config/rtp"):
                  print("The config/rtp directory does not exist!")
              else:
                  print("Directory exists but no .txt files found.")
                  print("Files in config/rtp directory:")
                  for file in os.listdir("config/rtp"):
                      print(f"  - {os.path.join('config/rtp', file)}")
          else:
              print(f"Found {len(rtp_files)} RTP files to process:")
              for file in rtp_files:
                  print(f"  - {file}")
          
          # åˆ›å»ºä¸€ä¸ªåˆå¹¶çš„ç”¨æˆ·æ–‡ä»¶
          user_output_file = "output/user_result.m3u"
          with open(user_output_file, "w", encoding="utf-8") as user_file:
              # å†™å…¥M3Uå¤´éƒ¨
              user_file.write("#EXTM3U\n")
              # æ·»åŠ è½¬æ¢æ—¶é—´æ³¨é‡Š
              user_file.write(f"#Created by GitHub Actions: {now.strftime('%Y-%m-%d %H:%M:%S')} UTC\n\n")
          
          for rtp_file in rtp_files:
              # è·å–æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰ä½œä¸ºåœ°åŒºå
              file_name = os.path.basename(rtp_file)
              area_name = os.path.splitext(file_name)[0]  # å»æ‰.txtæ‰©å±•å
                  
              # åˆ›å»ºå¯¹åº”çš„è¾“å‡ºæ–‡ä»¶
              output_file = f"output/rtp/{area_name}.m3u"
              
              print(f"Processing {rtp_file} -> {output_file}")
              
              try:
                  # è¯»å–RTPæ–‡ä»¶
                  with open(rtp_file, "r", encoding="utf-8") as f:
                      lines = f.readlines()
                  
                  # åˆ›å»ºåˆ†ç»„å­—å…¸å­˜å‚¨å„ç»„é¢‘é“
                  grouped_channels = {}
                  
                  # é¦–å…ˆæŒ‰ç»„åˆ†ç±»æ‰€æœ‰é¢‘é“
                  for line in lines:
                      line = line.strip()
                      # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
                      if not line or line.startswith("#"):
                          continue
                          
                      # è§£æRTPåœ°å€è¡Œï¼Œæ ¼å¼å¯èƒ½æ˜¯: é¢‘é“å,rtp://IP:ç«¯å£
                      parts = line.split(",")
                      if len(parts) >= 2:
                          channel_name = parts[0].strip()
                          rtp_address = parts[1].strip()
                          
                          # è·å–é¢‘é“ä¿¡æ¯
                          channel_info = get_channel_info(channel_name)
                          
                          # å°†é¢‘é“æ·»åŠ åˆ°ç›¸åº”çš„ç»„
                          group = channel_info["group_title"]
                          if group not in grouped_channels:
                              grouped_channels[group] = []
                          
                          grouped_channels[group].append((channel_name, rtp_address, channel_info))
                  
                  # åˆ›å»ºM3Uæ–‡ä»¶
                  with open(output_file, "w", encoding="utf-8") as f:
                      # å†™å…¥M3Uå¤´éƒ¨
                      f.write("#EXTM3U\n")
                      # æ·»åŠ è½¬æ¢æ—¶é—´æ³¨é‡Š
                      f.write(f"#Created by GitHub Actions: {now.strftime('%Y-%m-%d %H:%M:%S')} UTC\n")
                      f.write(f"#Source: {area_name}\n\n")
                      
                      # ç»Ÿè®¡å¤„ç†çš„é¢‘é“æ•°
                      total_channel_count = 0
                      
                      # å®šä¹‰ç»„çš„æ˜¾ç¤ºé¡ºåº
                      group_order = [
                          "ğŸ“ºå¤®è§†é¢‘é“", 
                          "ğŸ“ºå«è§†é¢‘é“", 
                          "ğŸ“ºä¸Šæµ·é¢‘é“", 
                          "ğŸ“ºåŒ—äº¬é¢‘é“", 
                          "ğŸ“ºå¹¿ä¸œé¢‘é“", 
                          "ğŸ“ºæµ™æ±Ÿé¢‘é“", 
                          "ğŸ“ºæ±Ÿè‹é¢‘é“", 
                          "ğŸ“ºæ¹–å—æ¹–åŒ—é¢‘é“", 
                          "ğŸ“ºå±±ä¸œå±±è¥¿é¢‘é“", 
                          "ğŸ“ºä¸œåŒ—é¢‘é“", 
                          "ğŸ“ºè¥¿å—é¢‘é“", 
                          "ğŸ“ºæ²³å—æ²³åŒ—é¢‘é“", 
                          "ğŸ“ºå®‰å¾½ç¦å»ºæ±Ÿè¥¿é¢‘é“", 
                          "ğŸ“ºè¥¿åŒ—é¢‘é“", 
                          "ğŸ“ºå†…è’™å¤è¥¿è—é¢‘é“", 
                          "ğŸ¬å½±è§†é¢‘é“", 
                          "âš½ä½“è‚²é¢‘é“", 
                          "ğŸ“°æ–°é—»é¢‘é“", 
                          "ğŸ§¸å°‘å„¿é¢‘é“", 
                          "ğŸµéŸ³ä¹é¢‘é“", 
                          "ğŸŒçºªå½•ç‰‡é¢‘é“", 
                          "ğŸ“ºå…¶ä»–é¢‘é“"
                      ]
                      
                      # æŒ‰ç»„é¡ºåºå†™å…¥é¢‘é“
                      for group in group_order:
                          if group in grouped_channels and grouped_channels[group]:
                              # æŒ‰é¢‘é“åç§°æ’åº
                              channels = sorted(grouped_channels[group], key=lambda x: x[0])
                              
                              # å†™å…¥ç»„å†…æ‰€æœ‰é¢‘é“
                              for channel_name, rtp_address, info in channels:
                                  tvg_id = info["tvg_id"]
                                  tvg_name = info["tvg_name"]
                                  tvg_logo = info["tvg_logo"]
                                  group_title = info["group_title"]
                                  
                                  # ç”Ÿæˆå®Œæ•´çš„EXTINFè¡Œ
                                  f.write(f'#EXTINF:-1 tvg-name="{tvg_name}" tvg-logo="{tvg_logo}" group-title="{group_title}",{channel_name}\n')
                                  f.write(f"{rtp_address}\n")
                                  total_channel_count += 1
                                  
                                  # åŒæ—¶å†™å…¥åˆ°ç”¨æˆ·åˆå¹¶æ–‡ä»¶
                                  with open(user_output_file, "a", encoding="utf-8") as user_file:
                                      user_file.write(f'#EXTINF:-1 tvg-name="{tvg_name}" tvg-logo="{tvg_logo}" group-title="{group_title}",{channel_name}\n')
                                      user_file.write(f"{rtp_address}\n")
                  
                  print(f"Created M3U file: {output_file} with {total_channel_count} channels in {len(grouped_channels)} groups")
              except Exception as e:
                  print(f"Error processing {rtp_file}: {str(e)}")

          print(f"Created merged user file: {user_output_file}")
          print("Conversion completed!")
          EOF

      - name: Run conversion script
        run: python convert_rtp_to_m3u.py
        
      - name: List output files
        run: |
          echo "Generated output files:"
          find output/rtp -type f | sort
          echo "Generated user merged file:"
          ls -l output/user_result.m3u
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add output/rtp/ output/user_result.m3u
          git commit -m "Update RTP to M3U conversion with beautiful format [Manual Trigger]" -a || echo "No changes to commit"
          git push
